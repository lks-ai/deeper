<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- Ensure mobile responsiveness -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign In</title>
  <!-- Load the Supabase client from a CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 20px;
      border-bottom: 1px solid #ccc;
      margin-bottom: 20px;
    }
    #userBadge {
      display: flex;
      align-items: center;
    }
    #userBadge img {
      border-radius: 50%;
      width: 40px;
      height: 40px;
      margin-right: 10px;
    }
    .tabs { text-align: center; margin-bottom: 20px; }
    .tabs button { margin: 0 5px; padding: 10px 15px; }
    .auth-form { display: none; border: 1px solid #ccc; padding: 15px; border-radius: 5px; }
    .auth-form.active { display: block; }
    .form-group { margin-bottom: 10px; }
    label { display: block; margin-bottom: 5px; }
    input { width: 100%; padding: 8px; box-sizing: border-box;}
    .oauth-buttons { text-align: center; }
    .oauth-buttons button { margin: 5px; padding: 10px 15px; }
    #result { margin-top: 20px; text-align: center; }
  </style>
  <link id="styleHierarchy" rel="stylesheet" href="themes/dark/hierarchy.css">
  <link id="styleSophia" rel="stylesheet" href="themes/dark/sophia.css">

</head>
<body>
  <!-- Header with a user badge -->
  <header>
    <h1>Supabase Auth Template</h1>
    <div id="userBadge">
      <img src="https://via.placeholder.com/40" alt="User Avatar" id="userAvatar" />
      <span id="userName">Guest</span>
      <button id="logoutButton" style="display: none; margin-left:10px;">Logout</button>
    </div>
  </header>

  <div class="tabs">
    <button data-target="email-login-form">Email Login</button>
    <button data-target="email-signup-form">Email Signup</button>
    <button data-target="oauth-form">OAuth Login</button>
  </div>

  <div id="auth-forms">
    <!-- Email Login Form -->
    <div id="email-login-form" class="auth-form active">
      <h2>Email Login</h2>
      <div class="form-group">
        <label for="login-email">Email:</label>
        <input type="email" id="login-email" placeholder="you@example.com" required>
      </div>
      <div class="form-group">
        <label for="login-password">Password:</label>
        <input type="password" id="login-password" placeholder="Enter your password" required>
      </div>
      <button id="login-button">Login</button>
    </div>

    <!-- Email Signup Form -->
    <div id="email-signup-form" class="auth-form">
      <h2>Email Signup</h2>
      <div class="form-group">
        <label for="signup-email">Email:</label>
        <input type="email" id="signup-email" placeholder="you@example.com" required>
      </div>
      <div class="form-group">
        <label for="signup-password">Password:</label>
        <input type="password" id="signup-password" placeholder="Create a password" required>
      </div>
      <button id="signup-button">Sign Up</button>
    </div>

    <!-- OAuth Login Form -->
    <div id="oauth-form" class="auth-form">
      <h2>OAuth Login</h2>
      <div class="oauth-buttons">
        <button data-provider="google" class="oauth-button">Login with Google</button>
        <button data-provider="discord" class="oauth-button">Login with Discord</button>
      </div>
    </div>
  </div>

  <div id="result"></div>

  <!-- AuthManager Module: verifies the JWT via /auth -->
  <script src="src/auth.js"></script>

  <!-- Main App Script -->
  <script>
    /***************
     * SUPABASE SETUP
     ***************/
    const SUPABASE_URL = '[[SUPABASE_URL_HERE]]'; // Replace with your Supabase URL
    const SUPABASE_ANON_KEY = '[[SUPABASE_ANON_KEY_HERE]]';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /*********************
     * AUTHENTICATION API
     *********************/
    async function emailLogin(email, password) {
      const { data, error } = await supabaseClient.auth.signInWithPassword({
        email, password,
        options: {
          redirectTo: `${window.location.origin}${window.location.pathname}`,
        }, 
      });
      if (error) {
        return { success: false, message: error.message };
      }
      let d = { success: true, message: 'Logged in successfully!', jwt: data.session?.access_token };
      setTimeout(function(){
        window.location.href = window.location.origin;
      }, 200);
      return d;
    }

    async function emailSignup(email, password) {
      const { data, error } = await supabaseClient.auth.signUp({ email, password });
      if (error) {
        return { success: false, message: error.message };
      }
      return { success: true, message: 'Signup successful! Please check your email for confirmation.' };
    }

    async function oauthLogin(provider) {
      const { error } = await supabaseClient.auth.signInWithOAuth({ 
        provider,
        options: {
          redirectTo: `${window.location.origin}${window.location.pathname}`,
        },
      });
      if (error) {
        return { success: false, message: error.message };
      }
      return { success: true, message: 'OAuth flow initiated. Check the popup or redirect.' };
    }

    async function logout() {
      const { error } = await supabaseClient.auth.signOut();
      if (error) {
        showResult("Logout failed: " + error.message, true);
      } else {
        localStorage.removeItem('jwt');
        localStorage.removeItem('userId');
        localStorage.removeItem('image_url');
        localStorage.removeItem('userName');
        updateUserBadge(null);
        showResult("Logged out successfully!");
      }
    }

    /*********************
     * AUTO-LOGIN & UI UPDATE
     *********************/
    // autoLogin checks for a JWT in localStorage, verifies it via AuthManager.verify,
    // updates localStorage with server-verified data, and updates the UI accordingly.
    async function autoLogin() {
      const jwt = localStorage.getItem('jwt');
      if (!jwt) {
        console.log("No JWT found in localStorage.");
        return false;
      }
      try {
        const userData = await AuthManager.verify(jwt, true);
        localStorage.setItem('userId', userData.id);
        if (userData.image_url) {
          localStorage.setItem('image_url', userData.image_url);
        }
        if (userData.name) {
          localStorage.setItem('userName', userData.name);
        }
        updateUserBadge({
          image_url: userData.image_url || "https://via.placeholder.com/40",
          userName: userData.name || "User"
        });
        console.log("JWT verified successfully.");
        return true;
      } catch (error) {
        console.error("JWT verification failed:", error);
        localStorage.removeItem('jwt');
        localStorage.removeItem('userId');
        localStorage.removeItem('image_url');
        localStorage.removeItem('userName');
        updateUserBadge(null);
        return false;
      }
    }

    function updateUserBadge(user) {
      const userAvatar = document.getElementById('userAvatar');
      const userNameElem = document.getElementById('userName');
      const logoutButton = document.getElementById('logoutButton');
      if (user) {
        userAvatar.src = user.image_url;
        userNameElem.textContent = user.userName;
        logoutButton.style.display = 'inline-block';
      } else {
        userAvatar.src = "https://via.placeholder.com/40";
        userNameElem.textContent = "Guest";
        logoutButton.style.display = 'none';
      }
    }

    function showResult(message, isError = false) {
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = `<p style="color:${isError ? 'red' : 'green'}">${message}</p>`;
    }

    function activateForm(formId) {
      document.querySelectorAll('.auth-form').forEach(form => {
        form.classList.remove('active');
      });
      document.querySelectorAll('.auth-form input').forEach(input => {
        const idParts = input.id.split('-', 2);
        input.addEventListener('keydown', function(){
          const b = document.querySelector(`.auth-form button#${idParts[0]}-button`);
          b.click();
        });
      });
      document.getElementById(formId).classList.add('active');
    }

    /*********************
     * EVENT LISTENERS
     *********************/
    document.querySelectorAll('.tabs button').forEach(button => {
      button.addEventListener('click', () => {
        activateForm(button.getAttribute('data-target'));
      });
    });

    document.getElementById('login-button').addEventListener('click', async () => {
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;
      if (!email || !password) {
        showResult('Please enter both email and password.', true);
        return;
      }
      const result = await emailLogin(email, password);
      showResult(result.message, !result.success);
      if (result.success && result.jwt) {
        // Store the JWT and then verify via AuthManager.
        localStorage.setItem('jwt', result.jwt);
        setTimeout(async () => {
          if (await autoLogin()) {
            showResult("Auto login successful!");
          }
        }, 500);
      }
    });

    document.getElementById('signup-button').addEventListener('click', async () => {
      const email = document.getElementById('signup-email').value.trim();
      const password = document.getElementById('signup-password').value;
      if (!email || !password) {
        showResult('Please enter both email and password.', true);
        return;
      }
      const result = await emailSignup(email, password);
      showResult(result.message, !result.success);
    });

    document.querySelectorAll('.oauth-button').forEach(button => {
      button.addEventListener('click', async (e) => {
        const provider = e.currentTarget.getAttribute('data-provider');
        const result = await oauthLogin(provider);
        showResult(result.message, !result.success);
      });
    });

    document.getElementById('logoutButton').addEventListener('click', logout);

    // On page load, try auto-login by verifying the JWT via AuthManager.
    // document.addEventListener('DOMContentLoaded', async function() {
    //   if (await autoLogin()) {
    //     showResult("Welcome back!");
    //   } else {
    //     showResult("You are not logged in.");
    //   }
    // });

    // On page load, check if the URL contains an access token in the hash (from OAuth redirect)
    document.addEventListener('DOMContentLoaded', async function() {
      const hash = window.location.hash;
      if (hash && hash.includes("access_token=")) {
        const params = new URLSearchParams(hash.substring(1));
        const accessToken = params.get("access_token");
        if (accessToken) {
          // Save the token in localStorage and clear the hash
          localStorage.setItem('jwt', accessToken);
          history.replaceState(null, "", window.location.pathname);
        }
      }
      if (await autoLogin()) {
        showResult("Welcome back!");
        window.location.href = window.location.origin;
      } else {
        showResult("You are not logged in.");
      }
      activateForm('email-login-form');
    });


  </script>
</body>
</html>
